// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis]
}

model User {
  id                 Int      @id @default(autoincrement())
  username           String   @unique @db.VarChar(255)
  email              String   @unique @db.VarChar(255)
  passwordHash       String   @map("password_hash") @db.VarChar(255)
  avatarUrl          String?  @map("avatar_url") @db.VarChar(500)
  timezone           String?  @default("UTC") @db.VarChar(100)
  activityCategories Json     @default("[{\"name\":\"Sightseeing\",\"emoji\":\"\ud83c\udfdb\ufe0f\"},{\"name\":\"Dining\",\"emoji\":\"\ud83c\udf7d\ufe0f\"},{\"name\":\"Adventure\",\"emoji\":\"\ud83e\uddd7\"},{\"name\":\"Entertainment\",\"emoji\":\"\ud83c\udfad\"},{\"name\":\"Shopping\",\"emoji\":\"\ud83d\udecd\ufe0f\"},{\"name\":\"Recreation\",\"emoji\":\"\u26bd\"},{\"name\":\"Cultural\",\"emoji\":\"\ud83c\udfdb\ufe0f\"},{\"name\":\"Sports\",\"emoji\":\"\ud83c\udfc5\"},{\"name\":\"Wellness\",\"emoji\":\"\ud83e\uddd8\"},{\"name\":\"Tour\",\"emoji\":\"\ud83d\udc65\"},{\"name\":\"Other\",\"emoji\":\"\ud83d\udccc\"}]") @map("activity_categories")
  tripTypes          Json     @default("[{\"name\":\"Leisure\",\"emoji\":\"\ud83c\udfd6\ufe0f\"},{\"name\":\"Business\",\"emoji\":\"\ud83d\udcbc\"},{\"name\":\"Road Trip\",\"emoji\":\"\ud83d\ude97\"},{\"name\":\"Backpacking\",\"emoji\":\"\ud83c\udf92\"},{\"name\":\"Cruise\",\"emoji\":\"\ud83d\udea2\"},{\"name\":\"Study Abroad\",\"emoji\":\"\ud83d\udcda\"},{\"name\":\"Volunteer\",\"emoji\":\"\ud83e\udd1d\"},{\"name\":\"Pilgrimage\",\"emoji\":\"\ud83d\udd4a\ufe0f\"},{\"name\":\"Adventure\",\"emoji\":\"\ud83e\uddd7\"},{\"name\":\"Family\",\"emoji\":\"\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc67\u200d\ud83d\udc66\"},{\"name\":\"Honeymoon\",\"emoji\":\"\ud83d\udc95\"},{\"name\":\"Other\",\"emoji\":\"\ud83d\udccc\"}]") @map("trip_types")
  dietaryPreferences Json     @default("[]") @map("dietary_preferences")
  immichApiUrl       String?  @map("immich_api_url") @db.VarChar(500)
  immichApiKey       String?  @map("immich_api_key") @db.VarChar(500)
  weatherApiKey      String?  @map("weather_api_key") @db.VarChar(500)
  aviationstackApiKey String? @map("aviationstack_api_key") @db.VarChar(500)
  openrouteserviceApiKey String? @map("openrouteservice_api_key") @db.VarChar(500)
  smtpProvider       String?  @map("smtp_provider") @db.VarChar(50)
  smtpHost           String?  @map("smtp_host") @db.VarChar(500)
  smtpPort           Int?     @map("smtp_port")
  smtpSecure         Boolean? @map("smtp_secure")
  smtpUser           String?  @map("smtp_user") @db.VarChar(500)
  smtpPassword       String?  @map("smtp_password") @db.VarChar(500)
  smtpFrom           String?  @map("smtp_from") @db.VarChar(500)
  passwordVersion    Int      @default(0) @map("password_version")
  useCustomMapStyle  Boolean  @default(true) @map("use_custom_map_style")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Travel Partner Settings (bidirectional - both users share with each other)
  travelPartnerId          Int?    @map("travel_partner_id")
  defaultPartnerPermission String  @default("edit") @map("default_partner_permission") @db.VarChar(50) // view, edit, admin

  trips              Trip[]
  tags               TripTag[]
  companions         TravelCompanion[]
  locationCategories LocationCategory[]
  tripCollaborators  TripCollaborator[]
  checklists         Checklist[]
  invitationsSent    TripInvitation[] @relation("InvitationsSent")
  travelDocuments    TravelDocument[]
  tripSeries         TripSeries[]
  userInvitationsSent     UserInvitation[] @relation("UserInvitationsSent")
  userInvitationsAccepted UserInvitation[] @relation("UserInvitationsAccepted")

  // Self-relation for travel partner
  travelPartner      User?   @relation("TravelPartner", fields: [travelPartnerId], references: [id], onDelete: SetNull)
  partnerOf          User[]  @relation("TravelPartner")

  @@index([travelPartnerId])
  @@map("users")
}

model Trip {
  id                  Int      @id @default(autoincrement())
  userId              Int      @map("user_id")
  title               String   @db.VarChar(500)
  description         String?  @db.Text
  startDate           DateTime? @map("start_date") @db.Date
  endDate             DateTime? @map("end_date") @db.Date
  timezone            String?  @db.VarChar(100)
  status              String   @db.VarChar(50) // Dream, Planning, Planned, In Progress, Completed, Cancelled
  tripType            String?  @map("trip_type") @db.VarChar(100)
  tripTypeEmoji       String?  @map("trip_type_emoji") @db.VarChar(50)
  privacyLevel        String   @map("privacy_level") @db.VarChar(50) // Private, Shared, Public
  coverPhotoId        Int?     @map("cover_photo_id")
  bannerPhotoId       Int?     @map("banner_photo_id")
  addToPlacesVisited  Boolean  @default(false) @map("add_to_places_visited")
  excludeFromAutoShare Boolean @default(false) @map("exclude_from_auto_share")
  seriesId            Int?     @map("series_id")
  seriesOrder         Int?     @map("series_order")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user               User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  series             TripSeries?            @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  coverPhoto         Photo?                 @relation("TripCoverPhoto", fields: [coverPhotoId], references: [id], onDelete: SetNull)
  bannerPhoto        Photo?                 @relation("TripBannerPhoto", fields: [bannerPhotoId], references: [id], onDelete: SetNull)
  locations          Location[]
  photos             Photo[]                @relation("TripPhotos")
  activities         Activity[]
  transportation     Transportation[]
  lodging            Lodging[]
  journalEntries     JournalEntry[]
  photoAlbums        PhotoAlbum[]
  weatherData        WeatherData[]
  tagAssignments     TripTagAssignment[]
  companionAssignments TripCompanion[]
  collaborators      TripCollaborator[]
  invitations        TripInvitation[]
  checklists         Checklist[]
  entityLinks        EntityLink[]
  dismissedValidationIssues DismissedValidationIssue[]
  languages          TripLanguage[]

  @@index([userId, status])
  @@index([startDate, endDate])
  @@index([seriesId, seriesOrder])
  @@map("trips")
}

model TripSeries {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String   @db.VarChar(500)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  trips Trip[]

  @@index([userId])
  @@map("trip_series")
}

model TripTag {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String   @db.VarChar(255)
  color     String?  @db.VarChar(7) // Hex color code (background)
  textColor String?  @map("text_color") @db.VarChar(7) // Hex color code (text)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments TripTagAssignment[]

  @@unique([userId, name])
  @@map("trip_tags")
}

model TripTagAssignment {
  id        Int      @id @default(autoincrement())
  tripId    Int      @map("trip_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  trip Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tag  TripTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tripId, tagId])
  @@map("trip_tag_assignments")
}

model TravelCompanion {
  id                 Int      @id @default(autoincrement())
  userId             Int      @map("user_id")
  name               String   @db.VarChar(255)
  email              String?  @db.VarChar(255)
  phone              String?  @db.VarChar(20)
  notes              String?  @db.Text
  relationship       String?  @db.VarChar(255)
  isMyself           Boolean  @default(false) @map("is_myself")
  avatarUrl          String?  @map("avatar_url") @db.VarChar(500)
  dietaryPreferences Json     @default("[]") @map("dietary_preferences")
  createdAt          DateTime @default(now()) @map("created_at")

  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tripAssignments  TripCompanion[]

  @@map("travel_companions")
}

model TripCompanion {
  id          Int      @id @default(autoincrement())
  tripId      Int      @map("trip_id")
  companionId Int      @map("companion_id")
  createdAt   DateTime @default(now()) @map("created_at")

  trip      Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  companion TravelCompanion @relation(fields: [companionId], references: [id], onDelete: Cascade)

  @@unique([tripId, companionId])
  @@map("trip_companions")
}

model TripCollaborator {
  id              Int      @id @default(autoincrement())
  tripId          Int      @map("trip_id")
  userId          Int      @map("user_id")
  permissionLevel String   @map("permission_level") @db.VarChar(50) // view, edit, admin
  createdAt       DateTime @default(now()) @map("created_at")

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@map("trip_collaborators")
}

model TripInvitation {
  id              Int      @id @default(autoincrement())
  tripId          Int      @map("trip_id")
  invitedByUserId Int      @map("invited_by_user_id")
  email           String   @db.VarChar(255)
  permissionLevel String   @map("permission_level") @db.VarChar(50) // view, edit, admin
  token           String   @unique @db.VarChar(255) // Unique token for accepting invitation
  status          String   @default("pending") @db.VarChar(50) // pending, accepted, declined, expired
  message         String?  @db.Text // Optional personal message
  expiresAt       DateTime @map("expires_at")
  respondedAt     DateTime? @map("responded_at")
  createdAt       DateTime @default(now()) @map("created_at")

  trip      Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  invitedBy User @relation("InvitationsSent", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([tripId, status])
  @@map("trip_invitations")
}

model Location {
  id                   Int       @id @default(autoincrement())
  tripId               Int       @map("trip_id")
  parentId             Int?      @map("parent_id")
  name                 String    @db.VarChar(500)
  address              String?   @db.Text
  latitude             Decimal?  @db.Decimal(10, 8)
  longitude            Decimal?  @db.Decimal(11, 8)
  categoryId           Int?      @map("category_id")
  visitDatetime        DateTime? @map("visit_datetime")
  visitDurationMinutes Int?      @map("visit_duration_minutes")
  notes                String?   @db.Text
  coordinates          Unsupported("geography(Point, 4326)")?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  trip                     Trip                  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  category                 LocationCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  parent                   Location?             @relation("LocationChildren", fields: [parentId], references: [id], onDelete: SetNull)
  children                 Location[]            @relation("LocationChildren")
  // Note: Activity, Lodging, and PhotoAlbum associations are handled via EntityLink system, not direct FKs
  transportationStarts     Transportation[]      @relation("StartLocation")
  transportationEnds       Transportation[]      @relation("EndLocation")
  weatherData              WeatherData[]

  @@index([tripId])
  @@index([parentId])
  @@index([coordinates], type: Gist)
  @@map("locations")
}

model LocationCategory {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id") // NULL for system default categories
  name      String   @db.VarChar(255)
  icon      String?  @db.VarChar(100)
  color     String?  @db.VarChar(7) // Hex color code
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")

  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations Location[]

  @@index([userId])
  @@map("location_categories")
}

model Photo {
  id             Int       @id @default(autoincrement())
  tripId         Int       @map("trip_id")
  source         String    @default("local") @db.VarChar(50) // 'local' or 'immich'
  mediaType      String    @default("image") @map("media_type") @db.VarChar(20) // 'image' or 'video'
  immichAssetId  String?   @map("immich_asset_id") @db.VarChar(255)
  localPath      String?   @map("local_path") @db.VarChar(500)
  thumbnailPath  String?   @map("thumbnail_path") @db.VarChar(500)
  duration       Int?      // Video duration in seconds
  caption        String?   @db.Text
  latitude       Decimal?  @db.Decimal(10, 8)
  longitude      Decimal?  @db.Decimal(11, 8)
  takenAt        DateTime? @map("taken_at")
  coordinates    Unsupported("geography(Point, 4326)")?
  uploadedAt     DateTime  @default(now()) @map("uploaded_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  trip                   Trip                    @relation("TripPhotos", fields: [tripId], references: [id], onDelete: Cascade)
  tripCoverPhoto         Trip[]                  @relation("TripCoverPhoto")
  tripBannerPhoto        Trip[]                  @relation("TripBannerPhoto")
  albumCoverPhoto        PhotoAlbum[]            @relation("AlbumCoverPhoto")
  albumAssignments       PhotoAlbumAssignment[]

  @@index([tripId, takenAt])
  @@index([tripId])
  @@index([takenAt])
  @@index([coordinates], type: Gist)
  @@map("photos")
}

model PhotoAlbum {
  id          Int      @id @default(autoincrement())
  tripId      Int      @map("trip_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  coverPhotoId Int?    @map("cover_photo_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  trip         Trip                   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  // Note: Location, Activity, and Lodging associations are handled via EntityLink system, not direct FKs
  coverPhoto   Photo?                 @relation("AlbumCoverPhoto", fields: [coverPhotoId], references: [id], onDelete: SetNull)
  photoAssignments PhotoAlbumAssignment[]

  @@index([tripId])
  @@map("photo_albums")
}

model PhotoAlbumAssignment {
  id        Int      @id @default(autoincrement())
  albumId   Int      @map("album_id")
  photoId   Int      @map("photo_id")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  album PhotoAlbum @relation(fields: [albumId], references: [id], onDelete: Cascade)
  photo Photo      @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([albumId, photoId])
  @@index([albumId])
  @@index([photoId])
  @@map("photo_album_assignments")
}

model Activity {
  id          Int       @id @default(autoincrement())
  tripId      Int       @map("trip_id")
  parentId    Int?      @map("parent_id")
  name        String    @db.VarChar(500)
  description String?   @db.Text
  category    String?   @db.VarChar(100) // sightseeing, dining, adventure, entertainment, etc.
  allDay      Boolean   @default(false) @map("all_day")
  startTime   DateTime? @map("start_time")
  endTime     DateTime? @map("end_time")
  timezone    String?   @db.VarChar(100)
  cost        Decimal?  @db.Decimal(10, 2)
  currency    String?   @db.VarChar(3)
  bookingUrl  String?   @map("booking_url") @db.VarChar(500)
  bookingReference String? @map("booking_reference") @db.VarChar(255)
  notes       String?   @db.Text
  manualOrder Int?      @map("manual_order") // Manual sort order (null = use chronological)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  trip        Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  // Note: Location association is handled via EntityLink system, not direct FK
  parent      Activity? @relation("ActivityChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children    Activity[] @relation("ActivityChildren")
  dietaryTags Json?     @map("dietary_tags")

  @@map("activities")
  @@index([tripId])
  @@index([parentId])
  @@index([tripId, manualOrder])
  @@index([startTime])
}

model Transportation {
  id                 Int       @id @default(autoincrement())
  tripId             Int       @map("trip_id")
  type               String    @db.VarChar(50) // Flight, Train, Bus, Ferry, etc.
  startLocationId    Int?      @map("start_location_id")
  startLocationText  String?   @map("start_location_text") @db.VarChar(500)
  endLocationId      Int?      @map("end_location_id")
  endLocationText    String?   @map("end_location_text") @db.VarChar(500)
  scheduledStart     DateTime? @map("scheduled_start")
  scheduledEnd       DateTime? @map("scheduled_end")
  startTimezone      String?   @map("start_timezone") @db.VarChar(100)
  endTimezone        String?   @map("end_timezone") @db.VarChar(100)
  actualStart        DateTime? @map("actual_start")
  actualEnd          DateTime? @map("actual_end")
  company            String?   @db.VarChar(255)
  referenceNumber    String?   @map("reference_number") @db.VarChar(255)
  seatNumber         String?   @map("seat_number") @db.VarChar(50)
  bookingReference   String?   @map("booking_reference") @db.VarChar(255)
  bookingUrl         String?   @map("booking_url") @db.VarChar(500)
  cost               Decimal?  @db.Decimal(10, 2)
  currency           String?   @db.VarChar(3)
  status             String    @default("on_time") @db.VarChar(50) // on_time, delayed, cancelled
  delayMinutes       Int?      @map("delay_minutes")
  notes              String?   @db.Text
  connectionGroupId  String?   @map("connection_group_id") @db.VarChar(100)
  isAutoGenerated    Boolean   @default(false) @map("is_auto_generated")
  calculatedDistance Decimal?  @map("calculated_distance") @db.Decimal(10, 2) // Route distance in kilometers
  calculatedDuration Decimal?  @map("calculated_duration") @db.Decimal(10, 2) // Route duration in minutes
  distanceSource     String?   @map("distance_source") @db.VarChar(20) // 'route' or 'haversine'
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  trip           Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  startLocation  Location?        @relation("StartLocation", fields: [startLocationId], references: [id], onDelete: SetNull)
  endLocation    Location?        @relation("EndLocation", fields: [endLocationId], references: [id], onDelete: SetNull)
  flightTracking FlightTracking?

  @@index([tripId])
  @@index([scheduledStart])
  @@index([connectionGroupId])
  @@map("transportation")
}

model Lodging {
  id                  Int       @id @default(autoincrement())
  tripId              Int       @map("trip_id")
  type                String    @db.VarChar(50)
  name                String    @db.VarChar(500)
  address             String?   @db.VarChar(1000)
  checkInDate         DateTime  @map("check_in_date")
  checkOutDate        DateTime  @map("check_out_date")
  timezone            String?   @db.VarChar(100)
  confirmationNumber  String?   @map("confirmation_number") @db.VarChar(255)
  bookingUrl          String?   @map("booking_url") @db.VarChar(500)
  cost                Decimal?  @db.Decimal(10, 2)
  currency            String?   @db.VarChar(3)
  notes               String?   @db.Text
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  trip     Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  // Note: Location association is handled via EntityLink system, not direct FK

  @@index([tripId])
  @@index([checkInDate])
  @@index([checkOutDate])
  @@map("lodging")
}

model JournalEntry {
  id           Int       @id @default(autoincrement())
  tripId       Int       @map("trip_id")
  date         DateTime? @db.Date // NULL for trip-level journals
  title        String?   @db.VarChar(500)
  content      String    @db.Text
  entryType    String    @map("entry_type") @db.VarChar(50) // trip, daily
  mood         String?   @db.VarChar(50)
  weatherNotes String?   @map("weather_notes") @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, date])
  @@map("journal_entries")
}

model WeatherData {
  id              Int       @id @default(autoincrement())
  tripId          Int       @map("trip_id")
  locationId      Int?      @map("location_id")
  date            DateTime  @db.Date
  temperatureHigh Decimal?  @map("temperature_high") @db.Decimal(5, 2)
  temperatureLow  Decimal?  @map("temperature_low") @db.Decimal(5, 2)
  conditions      String?   @db.VarChar(255)
  precipitation   Decimal?  @db.Decimal(5, 2)
  humidity        Int?
  windSpeed       Decimal?  @map("wind_speed") @db.Decimal(5, 2)
  sunrise         DateTime?
  sunset          DateTime?
  fetchedAt       DateTime  @default(now()) @map("fetched_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  trip     Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@index([locationId])
  @@map("weather_data")
}

model FlightTracking {
  id                 Int       @id @default(autoincrement())
  transportationId   Int       @unique @map("transportation_id")
  flightNumber       String?   @map("flight_number") @db.VarChar(50)
  airlineCode        String?   @map("airline_code") @db.VarChar(10)
  status             String?   @db.VarChar(50) // scheduled, active, landed, cancelled, diverted
  gate               String?   @db.VarChar(20)
  terminal           String?   @db.VarChar(20)
  baggageClaim       String?   @map("baggage_claim") @db.VarChar(20)
  departureDelay     Int?      @map("departure_delay") // Delay in minutes
  arrivalDelay       Int?      @map("arrival_delay") // Delay in minutes
  scheduledDeparture DateTime? @map("scheduled_departure")
  actualDeparture    DateTime? @map("actual_departure")
  scheduledArrival   DateTime? @map("scheduled_arrival")
  actualArrival      DateTime? @map("actual_arrival")
  lastUpdatedAt      DateTime  @default(now()) @map("last_updated_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  transportation Transportation @relation(fields: [transportationId], references: [id], onDelete: Cascade)

  @@map("flight_tracking")
}

model Checklist {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  tripId      Int?     @map("trip_id")
  name        String   @db.VarChar(500)
  description String?  @db.Text
  type        String   @db.VarChar(50) // 'custom', 'airports', 'countries', 'cities'
  isDefault   Boolean  @default(false) @map("is_default") // true for system-generated lists
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip  Trip?           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  items ChecklistItem[]

  @@index([userId])
  @@index([tripId])
  @@map("checklists")
}

model ChecklistItem {
  id           Int       @id @default(autoincrement())
  checklistId  Int       @map("checklist_id")
  name         String    @db.VarChar(500)
  description  String?   @db.Text
  isChecked    Boolean   @default(false) @map("is_checked")
  isDefault    Boolean   @default(false) @map("is_default") // true for pre-populated items
  sortOrder    Int       @default(0) @map("sort_order")
  metadata     Json?     // Store additional info like airport code, country code, etc.
  checkedAt    DateTime? @map("checked_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  checklist Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
  @@map("checklist_items")
}

model RouteCache {
  id        Int      @id @default(autoincrement())
  fromLat   Decimal  @map("from_lat") @db.Decimal(10, 8)
  fromLon   Decimal  @map("from_lon") @db.Decimal(11, 8)
  toLat     Decimal  @map("to_lat") @db.Decimal(10, 8)
  toLon     Decimal  @map("to_lon") @db.Decimal(11, 8)
  distance      Decimal  @db.Decimal(10, 2) // in kilometers
  duration      Decimal  @db.Decimal(10, 2) // in minutes
  profile       String   @db.VarChar(50) // driving-car, cycling-regular, foot-walking
  routeGeometry Json?    @map("route_geometry") // Array of [longitude, latitude] coordinates from OpenRouteService
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([fromLat, fromLon, toLat, toLon, profile], name: "route_cache_coords_profile_unique")
  @@map("route_cache")
}

// =============================================================================
// ENTITY LINKING SYSTEM
// =============================================================================
// Unified polymorphic junction table for linking any entity to any other entity
// within a trip. Replaces scattered FK relationships with a consistent pattern.

enum EntityType {
  PHOTO
  LOCATION
  ACTIVITY
  LODGING
  TRANSPORTATION
  JOURNAL_ENTRY
  PHOTO_ALBUM
}

enum LinkRelationship {
  RELATED        // Generic relationship
  TAKEN_AT       // Photo taken at location
  OCCURRED_AT    // Activity/event occurred at location
  PART_OF        // Sub-activity, nested location
  DOCUMENTS      // Journal documents this entity
  FEATURED_IN    // Photo featured in album/journal
}

model EntityLink {
  id           Int              @id @default(autoincrement())
  tripId       Int              @map("trip_id")

  // Source entity (the entity creating the link)
  sourceType   EntityType       @map("source_type")
  sourceId     Int              @map("source_id")

  // Target entity (the entity being linked to)
  targetType   EntityType       @map("target_type")
  targetId     Int              @map("target_id")

  // Relationship metadata
  relationship LinkRelationship @default(RELATED)
  sortOrder    Int?             @map("sort_order")
  notes        String?          @db.Text
  createdAt    DateTime         @default(now()) @map("created_at")

  trip         Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // Prevent duplicate links
  @@unique([tripId, sourceType, sourceId, targetType, targetId])
  // Index for querying "what is linked FROM this entity"
  @@index([tripId, sourceType, sourceId])
  // Index for querying "what is linked TO this entity"
  @@index([tripId, targetType, targetId])
  // Index for querying by source entity without tripId
  @@index([sourceType, sourceId])
  // Index for querying by target entity without tripId
  @@index([targetType, targetId])
  // Index for trip-level queries
  @@index([tripId])
  @@map("entity_links")
}

// =============================================================================
// VALIDATION ISSUE DISMISSAL SYSTEM
// =============================================================================
// Stores dismissed validation issues so users can acknowledge known issues
// without them affecting the trip health status.

enum ValidationIssueCategory {
  SCHEDULE        // Timeline conflicts, impossible travel times
  ACCOMMODATIONS  // Missing lodging
  TRANSPORTATION  // Gaps, tight connections
  COMPLETENESS    // Missing info (lower priority)
  DOCUMENTS       // Passport validity, visa requirements
}

model DismissedValidationIssue {
  id          Int                     @id @default(autoincrement())
  tripId      Int                     @map("trip_id")
  issueType   String                  @map("issue_type") @db.VarChar(100)
  issueKey    String                  @map("issue_key") @db.VarChar(500) // Unique identifier for specific issue instance
  category    ValidationIssueCategory
  dismissedAt DateTime                @default(now()) @map("dismissed_at")

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, issueType, issueKey])
  @@index([tripId])
  @@map("dismissed_validation_issues")
}

// =============================================================================
// TRAVEL DOCUMENT SYSTEM
// =============================================================================
// Stores user travel documents like passports, visas, ID cards, etc.

enum TravelDocumentType {
  PASSPORT
  VISA
  ID_CARD
  GLOBAL_ENTRY
  VACCINATION
}

model TravelDocument {
  id              Int                @id @default(autoincrement())
  userId          Int                @map("user_id")
  type            TravelDocumentType
  issuingCountry  String             @map("issuing_country") @db.VarChar(100)
  documentNumber  String?            @map("document_number") @db.VarChar(255)
  issueDate       DateTime?          @map("issue_date") @db.Date
  expiryDate      DateTime?          @map("expiry_date") @db.Date
  name            String             @db.VarChar(500) // Name on document or descriptive name
  notes           String?            @db.Text
  isPrimary       Boolean            @default(false) @map("is_primary")
  alertDaysBefore Int                @default(180) @map("alert_days_before")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiryDate])
  @@map("travel_documents")
}

// =============================================================================
// VISA REQUIREMENT REFERENCE DATA
// =============================================================================
// Static reference data for visa requirements between countries

model VisaRequirement {
  id                 Int      @id @default(autoincrement())
  passportCountry    String   @map("passport_country") @db.VarChar(100)
  destinationCountry String   @map("destination_country") @db.VarChar(100)
  visaRequired       Boolean  @map("visa_required")
  visaType           String   @map("visa_type") @db.VarChar(50) // visa_free, visa_on_arrival, e_visa, visa_required
  maxStayDays        Int?     @map("max_stay_days")
  notes              String?  @db.Text
  sourceUrl          String?  @map("source_url") @db.VarChar(500)
  lastVerified       DateTime? @map("last_verified") @db.Date

  @@unique([passportCountry, destinationCountry])
  @@index([passportCountry])
  @@index([destinationCountry])
  @@map("visa_requirements")
}

// =============================================================================
// TRIP LANGUAGE SYSTEM
// =============================================================================
// Manual language selection per trip for phrase lookup

model TripLanguage {
  id           Int    @id @default(autoincrement())
  tripId       Int    @map("trip_id")
  languageCode String @map("language_code") @db.VarChar(10)
  language     String @db.VarChar(100)

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, languageCode])
  @@index([tripId])
  @@map("trip_languages")
}

// =============================================================================
// LANGUAGE PHRASE BANK
// =============================================================================
// Common travel phrases for different languages

model LanguagePhrase {
  id            Int     @id @default(autoincrement())
  language      String  @db.VarChar(100)
  languageCode  String  @map("language_code") @db.VarChar(10)
  category      String  @db.VarChar(100) // greetings, directions, food, emergency, etc.
  english       String  @db.Text
  translation   String  @db.Text
  pronunciation String? @db.Text
  notes         String? @db.Text
  sortOrder     Int     @default(0) @map("sort_order")

  @@index([languageCode])
  @@index([category])
  @@index([languageCode, category])
  @@map("language_phrases")
}

// =============================================================================
// USER INVITATION SYSTEM
// =============================================================================
// Allows users to invite others to join the Travel Life application via email

enum UserInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model UserInvitation {
  id              Int                  @id @default(autoincrement())
  invitedByUserId Int?                 @map("invited_by_user_id") // NULL for system invites
  email           String               @db.VarChar(255)
  token           String               @unique @db.VarChar(255) // Unique token for accepting invitation
  status          UserInvitationStatus @default(PENDING)
  message         String?              @db.Text // Optional personal message from inviter
  expiresAt       DateTime             @map("expires_at")
  respondedAt     DateTime?            @map("responded_at")
  acceptedUserId  Int?                 @map("accepted_user_id") // ID of user who accepted (after registration)
  createdAt       DateTime             @default(now()) @map("created_at")

  invitedBy    User? @relation("UserInvitationsSent", fields: [invitedByUserId], references: [id], onDelete: SetNull)
  acceptedUser User? @relation("UserInvitationsAccepted", fields: [acceptedUserId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([token])
  @@index([status])
  @@index([invitedByUserId])
  @@index([email, status])  // Composite index for common email+status queries
  @@map("user_invitations")
}
